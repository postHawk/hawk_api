
var HAWK_API={ws:{socket:null,open:false},settings:{url:"wss://post-hawk.com:2222",user_id:false,encryption:{enabled:false,salt:"a3453fsdf564l546asdff6mas,.fma.S<Dfm"},debug:false},errors2string:{invalid_api_key:"Неверный ключ апи",user_not_register:"Пользователь с таким идентификатором не зарегистрирован в системе",user_not_exists:"Пользователь с таким идентификатором не найден",invalid_format_data:"Неверный фомат данных",invalid_data:"Общая ошибка данных. Ожидался POST-запрос",invalid_login_data:"Не верный логин получателя",send_message_yourself:"Нельзя отправить сообщение самому себе",invalid_login_format:"Неверный формат идентификатора",domain_not_register:"Данный домен не зарегистрирован в системе",user_not_online:"Пользователь не в сети",general_error:"Общая ошибка сервера",invalid_group_format:"Неверный формат идентификатора группы",invalid_group_count:"Группа должна быть не пустым массивом",access_denied_to_group:"Доступ к группе запрещён"},reinitialization:false,initialized:false,id_setted:false,queue:[],in_process:false,last_error:null,init:function(a){if(!HAWK_API.reinitialization){if(!!WebSocket){this.settings=$.extend(true,this.settings,a);if(!("CryptoJS" in window)){this.settings.encryption.enabled=false;console.warn("Отсутствует CryptoJS. Шифрование не возможно.")}if(!this.settings.user_id){this.print_error("необходимо указать user_id");return false}this.init.bind(this);this.bind_handler.bind(this);this.bind_default_hadler.bind(this);this.send_message.bind(this);this.get_user_id.bind(this);this.check_on_error.bind(this);this.get_url.bind(this);this.bind_handler("hawk.open",function(){HAWK_API.set_user_id()})}else{this.print_error("Технология не поддерживается");return false}this.initialized=true}if($("#hawk_fix_ssl").size()){$("#hawk_fix_ssl").remove()}if(!HAWK_API.last_error){HAWK_API.create_socket(HAWK_API.get_url())}return true},create_socket:function(a){this.ws.socket=new WebSocket(a);this.bind_default_hadler("onopen",this.on_open);this.bind_default_hadler("onmessage",this.on_message);this.bind_default_hadler("onclose",this.on_close);this.bind_default_hadler("onerror",this.on_error)},send_message:function(b,a){if(typeof a==="undefined"){a=true}if(this.in_process&&a){this.queue.push(b);return}this.in_process=true;if(typeof b=="object"){b.from=this.get_user_id();b.hawk_action=b.action||"send_message";delete b.action;b.domains=b.domains||[document.location.host];if(this.settings.encryption.enabled&&typeof CryptoJS!=="undefined"&&typeof CryptoJS.AES!=="undefined"&&typeof CryptoJS.enc.Base64!=="undefined"&&b.hasOwnProperty("text")&&b.text!==""){b.text=CryptoJS.AES.encrypt(JSON.stringify(b.text),this.settings.encryption.salt,{format:HAWK_API}).toString()}b=JSON.stringify(b)}this.ws.socket.send(b);$(HAWK_API).trigger("hawk.msg_sended",b)},get_group_list:function(a,b){a=a||[document.location.host];b=b||"get_group_list";var c={id:this.get_user_id(),domains:a,action:"get_group_list",event:b};this.send_message(c)},get_groups_by_user:function(d,a,b){a=a||[document.location.host];b=b||"get_group_by_simple_user";d=d||this.get_user_id();var c={id:d,domains:a,action:"get_group_by_simple_user",event:b};this.send_message(c)},get_users_by_group:function(b,a,c){HAWK_API.print_debug(b,a,c);if(typeof b==="object"&&b.length){a=a||[document.location.host];c=c||"get_by_group";var d={id:this.get_user_id(),domains:a,groups:b,action:"get_by_group",event:c};this.send_message(d)}else{this.print_error("Список групп должен быть не пустым массивом")}},add_user_to_group:function(b,e,a,c){a=a||[document.location.host];c=c||"add_in_groups";e=e||this.get_user_id();if(typeof b=="object"&&b.length){var d={id:e,groups:b,domains:a,action:"add_in_groups",event:c};this.send_message(d)}},remove_user_from_group:function(b,e,a,c){a=a||[document.location.host];c=c||"remove_from_groups";e=e||this.get_user_id();if(typeof b=="object"&&b.length){var d={id:e,groups:b,domains:a,action:"remove_from_groups",event:c};this.send_message(d)}},set_user_id:function(){if(this.check_user_id(this.settings.user_id)){this.send_message(this.settings.user_id)}else{this.print_error(this.errors2string.invalid_login_format)}},check_user_id:function(a){return/^[a-zA-Z\d\_]{3,64}$/.test(a)},get_user_id:function(){return this.settings.user_id},get_url:function(){return this.settings.url},bind_handler:function(b,a){if(b.search("hawk.")===-1){b="hawk."+b}$(this).on(b,a)},bind_default_hadler:function(b,a){if(typeof this.ws.socket[b]==="object"){this.ws.socket[b]=a}},unbind_handler:function(a){if(typeof this.ws.socket[a]==="object"){this.ws.socket[a]=null}},on_open:function(){HAWK_API.print_debug("open");HAWK_API.reinitialization=false;HAWK_API.ws.open=true;$(HAWK_API).trigger("hawk.open")},on_message:function(b){var a=JSON.parse(b.data);HAWK_API.print_debug(a);if(!a.hasOwnProperty("error")||a.error===false){if(HAWK_API.settings.encryption.enabled&&typeof CryptoJS!=="undefined"&&typeof CryptoJS.AES!=="undefined"&&typeof CryptoJS.enc.Base64!=="undefined"&&a.hasOwnProperty("text")&&a.text!==""){a.text=JSON.parse(CryptoJS.AES.decrypt(a.text,HAWK_API.settings.encryption.salt,{format:HAWK_API}).toString(CryptoJS.enc.Utf8))}var c="hawk.message";if(a.hasOwnProperty("from")&&a.from==="hawk_server"){c="hawk.server_message"}HAWK_API.print_debug(c);$(HAWK_API).trigger(c,[a]);if(!HAWK_API.id_setted){HAWK_API.id_setted=true;$(HAWK_API).trigger("hawk.initialized")}if(a.event){if(a.event.search("hawk.")===-1){a.event="hawk."+a.event}$(HAWK_API).trigger(a.event,[a])}}else{HAWK_API.check_on_error(a.error)}if(HAWK_API.queue.length){HAWK_API.send_message(HAWK_API.queue.shift(),false)}else{HAWK_API.in_process=false}},on_close:function(a){HAWK_API.print_debug("close");if(a.code===1006||a.code===1015){HAWK_API.fix_ssl()}else{setTimeout(HAWK_API.init,30000);$(HAWK_API).trigger("hawk.close")}HAWK_API.reinitialization=true},on_error:function(){HAWK_API.print_debug("error");$(HAWK_API).trigger("hawk.socket_error")},check_on_error:function(a){if(typeof this.errors2string[a]!=="undefined"){this.print_error(this.errors2string[a]);$(HAWK_API).trigger("hawk.server_error",[this.errors2string[a]]);HAWK_API.reinitialization=false;HAWK_API.last_error=this.errors2string[a]}},print_error:function(a){console.error(a)},print_debug:function(){if(HAWK_API.settings.debug){var c=new Error();var a=c.stack.split("\n").reverse()[0].trim();console.group(a);for(var b in arguments){console.debug(arguments[b])}console.groupEnd()}},stringify:function(a){var b={ct:a.ciphertext.toString(CryptoJS.enc.Base64)};if(a.iv){b.iv=a.iv.toString()}if(a.salt){b.s=a.salt.toString()}return JSON.stringify(b)},parse:function(a){var c=JSON.parse(a);var b=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(c.ct)});if(c.iv){b.iv=CryptoJS.enc.Hex.parse(c.iv)}if(c.s){b.salt=CryptoJS.enc.Hex.parse(c.s)}return b},fix_ssl:function(){$("body").append('<iframe id="hawk_fix_ssl" onload="HAWK_API.init()" style="display: none" src="'+HAWK_API.settings.url.replace("wss","https")+'">')}};